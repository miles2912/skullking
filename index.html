<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull King Scorekeeper</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the player selection buttons */
        .player-btn {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .player-btn.selected {
            background-color: #fca5a5; /* Red-300 */
            color: #1f2937; /* Gray-800 */
            border-color: #ef4444; /* Red-500 */
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Hide the number input arrows/spinners for all browsers */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: #ef4444;
            color: white;
            font-weight: bold;
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            display: none;
            animation: fadeInOut 4s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Message Box for user feedback -->
    <div id="message-box" class="message-box"></div>

    <!-- Main container for the app -->
    <div id="setup-screen" class="bg-gray-800 p-8 md:p-12 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-2xl text-center transition-all duration-300 transform scale-100 relative">
        
        <!-- Main title -->
        <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-6">Welcome to Skull King Scoring</h1>

        <!-- Player count selection -->
        <p class="text-lg md:text-xl text-gray-300 mb-8">How many players are playing?</p>
        
        <div class="flex justify-center space-x-4 mb-8">
            <button id="three-players-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                3 Players
            </button>
            <button id="four-players-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                4 Players
            </button>
        </div>

        <!-- Player name selection section -->
        <div id="player-selection-section" class="hidden mt-8 text-left">
            <h2 class="text-2xl md:text-3xl font-bold text-white mb-4 text-center">Select Players</h2>
            
            <!-- Message to guide the user on player selection -->
            <p id="selection-message" class="text-center text-gray-400 mb-6"></p>

            <div id="player-buttons-container" class="grid grid-cols-2 gap-4">
                <!-- Player buttons will be dynamically inserted here -->
            </div>
            
            <button id="start-game-btn" class="mt-8 w-full px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                Start Game!
            </button>
        </div>
    </div>
    
    <!-- Game screen (initially hidden) -->
    <div id="game-screen" class="hidden bg-gray-800 p-8 md:p-12 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-4xl text-center relative flex flex-col items-center">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-4">Skull King Scoring</h1>
        <h2 id="round-title" class="text-2xl md:text-3xl font-bold text-red-400 mb-6">Round 1 (1 Card)</h2>
        
        <div id="round-table-container" class="w-full overflow-x-auto">
            <table class="min-w-full bg-gray-900 rounded-lg shadow-inner">
                <thead>
                    <tr>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-left text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Player</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Bid</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Tricks Won</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Bonus</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Score</th>
                        <th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Total</th>
                    </tr>
                </thead>
                <tbody id="score-table-body">
                    <!-- Player rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Summary Table (initially hidden) -->
        <div id="summary-table-container" class="hidden w-full overflow-x-auto">
            <table class="min-w-full bg-gray-900 rounded-lg shadow-inner">
                <thead id="summary-table-head">
                    <!-- Summary table header will be dynamically inserted here -->
                </thead>
                <tbody id="summary-table-body">
                    <!-- Summary table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <div id="game-buttons" class="mt-8 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4 w-full">
            <button id="previous-round-btn" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 active:scale-95 hidden">
                Previous Round
            </button>
            <button id="next-round-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95">
                Next Round
            </button>
            <button id="end-game-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95 hidden">
                End Game
            </button>
        </div>
    </div>

    <!-- Bonus Modal (initially hidden) -->
    <div id="bonus-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal p-4">
        <div class="bg-gray-800 p-6 md:p-8 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Select Bonus Points</h3>
                <button id="close-bonus-modal-btn" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Bonus options grid -->
            <div class="grid grid-cols-2 gap-4">
                <!-- 10 points bonus -->
                <button class="bonus-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-xl shadow hover:bg-gray-600 transition-colors" data-value="10">
                    <span class="text-4xl">üÉè</span>
                    <span class="text-lg font-bold text-white mt-2">+10 Pts</span>
                    <span class="text-xs text-gray-400 text-center mt-1">Captured a 14 card</span>
                </button>
                <!-- 20 points bonus -->
                <button class="bonus-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-xl shadow hover:bg-gray-600 transition-colors" data-value="20">
                    <span class="text-4xl">üè¥‚Äç‚ò†Ô∏è</span>
                    <span class="text-lg font-bold text-white mt-2">+20 Pts</span>
                    <span class="text-xs text-gray-400 text-center mt-1">Captured Jolly Roger 14</span>
                </button>
                <!-- 20 points bonus (pirate captures mermaid) -->
                <button class="bonus-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-xl shadow hover:bg-gray-600 transition-colors" data-value="20">
                    <span class="text-4xl">üè¥‚Äç‚ò†Ô∏è &rarr; üßú‚Äç‚ôÄÔ∏è</span>
                    <span class="text-lg font-bold text-white mt-2">+20 Pts</span>
                    <span class="text-xs text-gray-400 text-center mt-1">Pirate captured a Mermaid</span>
                </button>
                <!-- 30 points bonus -->
                <button class="bonus-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-xl shadow hover:bg-gray-600 transition-colors" data-value="30">
                    <span class="text-4xl">üíÄüëë &rarr; üè¥‚Äç‚ò†Ô∏è</span>
                    <span class="text-lg font-bold text-white mt-2">+30 Pts</span>
                    <span class="text-xs text-gray-400 text-center mt-1">Skull King captured a Pirate</span>
                </button>
                <!-- 40 points bonus (mermaid captures skull king) -->
                <button class="bonus-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-xl shadow hover:bg-gray-600 transition-colors" data-value="40">
                    <span class="text-4xl">üßú‚Äç‚ôÄÔ∏è &rarr; üíÄüëë</span>
                    <span class="text-lg font-bold text-white mt-2">+40 Pts</span>
                    <span class="text-xs text-gray-400 text-center mt-1">Mermaid captured Skull King</span>
                </button>
                 <!-- 50 points bonus (pirate captures skull king) -->
                <button class="bonus-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-xl shadow hover:bg-gray-600 transition-colors" data-value="50">
                    <span class="text-4xl">üè¥‚Äç‚ò†Ô∏è &rarr; üíÄüëë</span>
                    <span class="text-lg font-bold text-white mt-2">+50 Pts</span>
                    <span class="text-xs text-gray-400 text-center mt-1">Pirate captured Skull King</span>
                </button>
            </div>
            
            <button id="clear-bonus-btn" class="mt-6 w-full px-4 py-3 bg-red-600 text-white font-bold rounded-full shadow hover:bg-red-700 transition duration-300">
                Clear Bonus
            </button>
        </div>
    </div>
    
    <!-- Kraken Modal (initially hidden) -->
    <div id="kraken-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal p-4">
        <div class="bg-gray-800 p-6 md:p-8 rounded-3xl shadow-2xl border border-gray-700 w-full max-w-sm text-center">
            <img src="https://placehold.co/150x150/0f172a/fca5a5?text=Kraken" alt="Kraken" class="mx-auto mb-4 rounded-xl">
            <p class="text-gray-300 mb-6">The total number of tricks won does not match the number of cards this round. This can happen when a Kraken is played.</p>
            <div class="flex justify-center space-x-4">
                <button id="kraken-yes-btn" class="px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 active:scale-95">
                    Yes
                </button>
                <button id="kraken-no-btn" class="px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                    No, go back
                </button>
            </div>
        </div>
    </div>


    <script>
        // Define the static player names
        const ALL_PLAYER_NAMES = ['Jason', 'Don', 'Les', 'Rich'];

        // Get references to the HTML elements
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const threePlayersBtn = document.getElementById('three-players-btn');
        const fourPlayersBtn = document.getElementById('four-players-btn');
        const playerSelectionSection = document.getElementById('player-selection-section');
        const playerButtonsContainer = document.getElementById('player-buttons-container');
        const selectionMessage = document.getElementById('selection-message');
        const startGameBtn = document.getElementById('start-game-btn');
        const roundTitle = document.getElementById('round-title');
        const roundTableContainer = document.getElementById('round-table-container');
        const scoreTableBody = document.getElementById('score-table-body');
        const summaryTableContainer = document.getElementById('summary-table-container');
        const summaryTableHead = document.getElementById('summary-table-head');
        const summaryTableBody = document.getElementById('summary-table-body');
        const previousRoundBtn = document.getElementById('previous-round-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const messageBox = document.getElementById('message-box');

        // Bonus modal elements
        const bonusModal = document.getElementById('bonus-modal');
        const closeBonusModalBtn = document.getElementById('close-bonus-modal-btn');
        const bonusButtons = document.querySelectorAll('.bonus-btn');
        const clearBonusBtn = document.getElementById('clear-bonus-btn');
        
        // Kraken modal elements
        const krakenModal = document.getElementById('kraken-modal');
        const krakenYesBtn = document.getElementById('kraken-yes-btn');
        const krakenNoBtn = document.getElementById('kraken-no-btn');

        let playerCount = 0;
        let selectedPlayers = [];
        let gameData = [];
        let currentRound = 1;
        let activePlayerIndex = -1; // To track which player's bonus is being edited

        // Function to display a temporary message to the user
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 4000);
        }

        // Function to render the player name buttons on the setup screen
        function renderPlayerButtons() {
            playerButtonsContainer.innerHTML = '';
            ALL_PLAYER_NAMES.forEach(name => {
                const button = document.createElement('button');
                button.textContent = name;
                button.classList.add(
                    'player-btn', 
                    'px-6', 'py-4', 
                    'bg-gray-700', 
                    'text-lg', 'text-white', 
                    'font-semibold', 
                    'rounded-xl', 
                    'shadow', 
                    'hover:bg-gray-600', 
                    'focus:outline-none', 
                    'focus:ring-2', 
                    'focus:ring-red-500'
                );
                
                if (selectedPlayers.includes(name)) {
                    button.classList.add('selected');
                }

                button.addEventListener('click', () => {
                    togglePlayerSelection(name);
                });

                playerButtonsContainer.appendChild(button);
            });
        }

        // Function to update the selection message and button state
        function updateSetupUI() {
            const numSelected = selectedPlayers.length;
            selectionMessage.textContent = `Selected players: ${numSelected} of ${playerCount}`;

            if (numSelected === playerCount) {
                startGameBtn.disabled = false;
            } else {
                startGameBtn.disabled = true;
            }
        }

        // Function to handle player button clicks (select/deselect)
        function togglePlayerSelection(name) {
            const index = selectedPlayers.indexOf(name);
            if (index > -1) {
                selectedPlayers.splice(index, 1);
            } else {
                if (selectedPlayers.length < playerCount) {
                    selectedPlayers.push(name);
                } else {
                    showMessage(`Cannot select more than ${playerCount} players.`);
                    return;
                }
            }
            renderPlayerButtons();
            updateSetupUI();
        }

        // Scoring Logic Function
        function calculateRoundScore(bid, tricksWon, bonus, round) {
            let score = 0;
            if (bid == tricksWon) {
                // Correct bid
                if (bid === 0) {
                    score = round * 10;
                } else {
                    score = bid * 20;
                }
                // Add bonus points if the bid was correct
                if (bonus !== null) {
                    score += bonus;
                }
            } else {
                // Incorrect bid
                if (bid === 0) {
                    score = tricksWon * -10;
                } else {
                    score = Math.abs(tricksWon - bid) * -10;
                }
            }
            return score;
        }

        // Function to recalculate total scores for all players up to the current round
        function recalculateTotalScores() {
            selectedPlayers.forEach((player, index) => {
                let total = 0;
                for (let i = 0; i < 10; i++) {
                    // Only add score if the round has been played
                    if (gameData[index].roundScores[i] !== null) {
                        total += gameData[index].roundScores[i];
                    }
                }
                gameData[index].totalScore = total;
            });
        }

        // Function to render the final game summary table
        function renderSummaryTable() {
            // Hide the round-by-round table and show the summary table
            roundTableContainer.classList.add('hidden');
            summaryTableContainer.classList.remove('hidden');

            // Update title and buttons for the end of the game
            roundTitle.textContent = "Final Scores";
            previousRoundBtn.classList.add('hidden');
            nextRoundBtn.classList.add('hidden');
            endGameBtn.classList.remove('hidden');
            endGameBtn.textContent = "Restart Game";
            
            // Clear previous table content
            summaryTableHead.innerHTML = '';
            summaryTableBody.innerHTML = '';
            
            // Create table header
            const headerRow = document.createElement('tr');
            let headerHtml = `<th class="px-4 py-2 border-b-2 border-gray-700 text-left text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Player</th>`;
            for (let i = 1; i <= 10; i++) {
                headerHtml += `<th class="px-2 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">R${i} Bid/Tricks</th>`;
            }
            headerHtml += `<th class="px-4 py-2 border-b-2 border-gray-700 text-center text-sm leading-4 font-medium text-gray-400 uppercase tracking-wider">Final Score</th>`;
            headerRow.innerHTML = headerHtml;
            summaryTableHead.appendChild(headerRow);

            // Populate the table with final game data
            gameData.forEach(player => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-600', 'transition-colors');

                // Player name cell
                let rowHtml = `<td class="px-4 py-4 whitespace-nowrap text-left font-medium text-white">${player.name}</td>`;
                
                // Bid/Tricks for each round
                for (let i = 0; i < 10; i++) {
                    const bid = player.bids[i] !== null ? player.bids[i] : '-';
                    const tricks = player.tricksWon[i] !== null ? player.tricksWon[i] : '-';
                    rowHtml += `<td class="px-2 py-4 text-center text-white">${bid}/${tricks}</td>`;
                }

                // Final Score cell
                rowHtml += `<td class="px-4 py-4 text-center font-bold text-white">${player.totalScore}</td>`;
                
                tr.innerHTML = rowHtml;
                summaryTableBody.appendChild(tr);
            });
        }
        
        // Function to render the game scoring table
        function renderScoreTable() {
            if (currentRound > 10) {
                renderSummaryTable();
                return;
            }

            // Hide the summary table and show the round-by-round table
            summaryTableContainer.classList.add('hidden');
            roundTableContainer.classList.remove('hidden');

            scoreTableBody.innerHTML = ''; // Clear table
            roundTitle.textContent = `Round ${currentRound} (${currentRound} Card${currentRound > 1 ? 's' : ''})`;

            // Show or hide the "Previous Round" button
            if (currentRound > 1) {
                previousRoundBtn.classList.remove('hidden');
            } else {
                previousRoundBtn.classList.add('hidden');
            }
            
            nextRoundBtn.classList.remove('hidden');
            endGameBtn.classList.add('hidden');

            selectedPlayers.forEach((playerName, index) => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'border-gray-700', 'hover:bg-gray-600', 'transition-colors');

                // Player Name Cell
                const nameCell = document.createElement('td');
                nameCell.textContent = playerName;
                nameCell.classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-left', 'font-medium', 'text-white');
                tr.appendChild(nameCell);

                // Bid Input Cell
                const bidCell = document.createElement('td');
                const bidInput = document.createElement('input');
                bidInput.type = 'number';
                const bidValue = gameData[index].bids[currentRound - 1];
                bidInput.value = bidValue !== null ? bidValue : '';
                bidInput.min = 0;
                bidInput.max = currentRound;
                bidInput.id = `bid-${index}`;
                bidInput.classList.add('w-20', 'bg-gray-700', 'text-white', 'rounded-md', 'px-2', 'py-1', 'text-center', 'focus:outline-none', 'focus:ring-2', 'focus:ring-red-400', 'focus:bg-gray-600');
                bidCell.classList.add('px-4', 'py-4', 'text-center');
                bidCell.appendChild(bidInput);
                tr.appendChild(bidCell);

                // Tricks Won Input Cell
                const tricksWonCell = document.createElement('td');
                const tricksInput = document.createElement('input');
                tricksInput.type = 'number';
                const tricksValue = gameData[index].tricksWon[currentRound - 1];
                tricksInput.value = tricksValue !== null ? tricksValue : '';
                tricksInput.min = 0;
                tricksInput.max = currentRound;
                tricksInput.id = `tricks-${index}`;
                tricksInput.classList.add('w-20', 'bg-gray-700', 'text-white', 'rounded-md', 'px-2', 'py-1', 'text-center', 'focus:outline-none', 'focus:ring-2', 'focus:ring-red-400', 'focus:bg-gray-600');
                tricksWonCell.classList.add('px-4', 'py-4', 'text-center');
                tricksWonCell.appendChild(tricksInput);
                tr.appendChild(tricksWonCell);

                // Bonus Cell (now a clickable div)
                const bonusCell = document.createElement('td');
                const bonusValue = gameData[index].bonuses[currentRound - 1];
                const bonusDisplay = document.createElement('div');
                bonusDisplay.textContent = bonusValue !== null ? `+${bonusValue}` : 'Tap';
                bonusDisplay.id = `bonus-${index}`;
                bonusDisplay.classList.add(
                    'w-20', 'bg-gray-700', 'text-white', 'rounded-md', 'px-2', 'py-1', 'text-center',
                    'cursor-pointer', 'select-none', 'transition-colors', 'hover:bg-gray-600',
                    'font-semibold'
                );
                
                // Add event listener to show the bonus modal
                bonusDisplay.addEventListener('click', () => {
                    activePlayerIndex = index;
                    bonusModal.classList.remove('hidden');
                });

                bonusCell.classList.add('px-4', 'py-4', 'text-center');
                bonusCell.appendChild(bonusDisplay);
                tr.appendChild(bonusCell);

                // Round Score Cell
                const roundScoreCell = document.createElement('td');
                const roundScoreValue = gameData[index].roundScores[currentRound - 1];
                roundScoreCell.textContent = roundScoreValue !== null ? roundScoreValue : '';
                roundScoreCell.classList.add('px-4', 'py-4', 'text-center', 'text-white', 'font-bold');
                tr.appendChild(roundScoreCell);
                
                // Total Score Cell
                const totalScoreCell = document.createElement('td');
                totalScoreCell.textContent = gameData[index].totalScore;
                totalScoreCell.classList.add('px-4', 'py-4', 'text-center', 'text-white', 'font-bold');
                tr.appendChild(totalScoreCell);

                scoreTableBody.appendChild(tr);
            });
        }
        
        // Function to process the scores and advance to the next round
        function processNextRound() {
            const bids = [];
            const tricksWon = [];

            for (let i = 0; i < playerCount; i++) {
                const bidValue = document.getElementById(`bid-${i}`).value;
                const tricksValue = document.getElementById(`tricks-${i}`).value;

                const bid = bidValue.trim() === '' ? null : parseInt(bidValue, 10);
                const tricks = tricksValue.trim() === '' ? null : parseInt(tricksValue, 10);

                bids.push(bid);
                tricksWon.push(tricks);
            }

            // Calculate scores for each player and save to gameData
            selectedPlayers.forEach((playerName, index) => {
                const bid = bids[index];
                const tricks = tricksWon[index];
                const bonus = gameData[index].bonuses[currentRound - 1];
                
                const roundScore = calculateRoundScore(bid, tricks, bonus, currentRound);
                
                gameData[index].bids[currentRound - 1] = bid;
                gameData[index].tricksWon[currentRound - 1] = tricks;
                gameData[index].roundScores[currentRound - 1] = roundScore;
            });
            
            // Recalculate all total scores after a round is complete
            recalculateTotalScores();
            
            currentRound++; // Move to the next round
            renderScoreTable(); // Re-render the table with new data
        }

        // Handle bonus button clicks inside the modal
        bonusButtons.forEach(button => {
            button.addEventListener('click', () => {
                const bonusValue = parseInt(button.dataset.value, 10);
                if (activePlayerIndex !== -1) {
                    gameData[activePlayerIndex].bonuses[currentRound - 1] = bonusValue;
                    renderScoreTable(); // Re-render the table to show the new bonus
                    bonusModal.classList.add('hidden');
                    activePlayerIndex = -1; // Reset active player
                }
            });
        });

        // Handle the "Clear Bonus" button click
        clearBonusBtn.addEventListener('click', () => {
            if (activePlayerIndex !== -1) {
                gameData[activePlayerIndex].bonuses[currentRound - 1] = null;
                renderScoreTable();
                bonusModal.classList.add('hidden');
                activePlayerIndex = -1;
            }
        });

        // Close bonus modal button listener
        closeBonusModalBtn.addEventListener('click', () => {
            bonusModal.classList.add('hidden');
            activePlayerIndex = -1;
        });
        
        // Kraken modal button listeners
        krakenYesBtn.addEventListener('click', () => {
            krakenModal.classList.add('hidden');
            processNextRound();
        });

        krakenNoBtn.addEventListener('click', () => {
            krakenModal.classList.add('hidden');
            // Do nothing, user can now edit the values
        });

        // Handle the "Next Round" button click
        nextRoundBtn.addEventListener('click', () => {
            let totalTricks = 0;
            let isValid = true;
            const bids = [];
            const tricksWon = [];

            for (let i = 0; i < playerCount; i++) {
                const bidValue = document.getElementById(`bid-${i}`).value;
                const tricksValue = document.getElementById(`tricks-${i}`).value;

                const bid = bidValue.trim() === '' ? null : parseInt(bidValue, 10);
                const tricks = tricksValue.trim() === '' ? null : parseInt(tricksValue, 10);

                if (isNaN(bid) || isNaN(tricks) || (bid !== null && (bid > currentRound || bid < 0)) || (tricks !== null && (tricks > currentRound || tricks < 0))) {
                    isValid = false;
                    break;
                }

                bids.push(bid);
                tricksWon.push(tricks);

                if (tricks !== null) {
                    totalTricks += tricks;
                }
            }
            
            if (!isValid) {
                showMessage("Invalid input. Please check bids and tricks won values.");
                return;
            }

            if (totalTricks !== currentRound) {
                krakenModal.classList.remove('hidden');
            } else {
                processNextRound();
            }
        });

        // Event listener for the "Previous Round" button
        previousRoundBtn.addEventListener('click', () => {
            if (currentRound > 1) {
                currentRound--;
                renderScoreTable();
            }
        });

        // Event listener for the "End Game" button
        endGameBtn.addEventListener('click', () => {
            // Reload the page to restart the game
            location.reload();
        });


        // Handle player count button clicks
        threePlayersBtn.addEventListener('click', () => {
            playerCount = 3;
            selectedPlayers = [];
            playerSelectionSection.classList.remove('hidden');
            renderPlayerButtons();
            updateSetupUI();
        });

        fourPlayersBtn.addEventListener('click', () => {
            playerCount = 4;
            selectedPlayers = [...ALL_PLAYER_NAMES];
            playerSelectionSection.classList.remove('hidden');
            renderPlayerButtons();
            updateSetupUI();
        });

        // Handle the "Start Game" button click
        startGameBtn.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent form submission
            
            // Initialize game data for each player
            gameData = selectedPlayers.map(name => ({
                name: name,
                bids: new Array(10).fill(null),
                tricksWon: new Array(10).fill(null),
                bonuses: new Array(10).fill(null),
                roundScores: new Array(10).fill(null),
                totalScore: 0
            }));

            // Hide the setup screen and show the game screen
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            // Render the initial score table
            renderScoreTable();
        });
    </script>

</body>
</html>
